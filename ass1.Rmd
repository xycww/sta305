Portugal fertility survey 1979

- [More information](https://wfs.dhsprogram.com/index.cfm?ccode=pt)
- [data source](https://wfs.dhsprogram.com/)
- [data dictionary](https://wfs.dhsprogram.com/pt/ptsr01.dct)

File `portugal.RData` on the course web site.  Code in `Assignment1.Rmd`


```{r dataDownload, include=FALSE}
pUrl = 'http://wfs.dhsprogram.com/pt/ptsr01.dat'
pName = file.path(tempdir(), 'portugal.dat')
if(!file.exists(pName)) {
  download.file(pUrl, pName)
}

datNames = rbind(
		age=c(45,2),
		ageMarried=c(149,2), 
		monthsSinceM = c(157,4),
#		failedPregnancies=c(421,2),
#		failedPregStill=c(423,2),
#		failedPregSpAb=c(425,2),
		pregnancies=c(433,2),
		children=c(435,2),
		sons=c(443,2),
#		firstBirthInterval = c(479,2),
		region = c(641,2),
		literacy = c(649,2)
)
		colnames(datNames ) = c('start','len')
		datNames = cbind(startm1=datNames[,1]-1,datNames, sum=apply(datNames, 1,sum))
		cbind(datNames[-1,1] , datNames[seq(1, nrow(datNames)-1),4])
		datNames[-1,1] = datNames[-1,2] - datNames[seq(1, nrow(datNames)-1),4]
		dWidths = as.vector(t(datNames[,c(1,3)]))
		dNames = paste(rep(rownames(datNames), rep(2, nrow(datNames))),
  	rep(c( "junk",""), nrow(datNames)), sep="") 
		
		dNames = dNames[dWidths > 0]
		dWidths = dWidths[dWidths > 0]
		
		formats = list(
			ageMarried = data.frame(code=1:7,  label=c(0,15,18,20,22,25,30)),
			region = data.frame(code=1:5, 
				label=c('lisbon','porto','20k+', '10-20k', 'lt10k')),
			literacy = data.frame(code=1:2, label=c('yes','no')),
			firstBirthInterval = data.frame(
					code = 1:8,
					label = c(
							'lt0','0-7', '8-11','12-23',
							'24-35','36-47','48-59','60-Inf'
							)
					)
		)

	

		formats$ageMarried$label = 
  	paste(formats$ageMarried$label, 'to',
  	c(formats$ageMarried$label[-1], 'Inf'), sep='')
  	formats$ageMarried = rbind(formats$ageMarried, data.frame(code=88, label='never'))

   
  portugal = read.fwf(
    pName,
    dWidths, col.names=dNames,
    header=FALSE)
  
  portugal = portugal[,grep("junk$", names(portugal), invert=TRUE)]

for(D in intersect(names(portugal), names(formats))){
  		portugal[[D]] = factor(portugal[[D]],
  			levels=formats[[D]]$code, 
				labels=formats[[D]]$label)
}
portugal$ageMarried = relevel(portugal$ageMarried, '22to25')
portugal$region = relevel(portugal$region, 'lt10k')

if(FALSE) save(portugal, file='portugal.RData')
```

```{r thedata}
head(portugal)
table(portugal$region)
```

Region is `lt10k` rural areas (less than 10,000 people), towns of size 10-20k, 20k+, and the two largest cities (Lisbon and Porto).


The Question: 

- How do literacy and age of marriage affect family size?
- After we account for known explanatory variables, how much variation (if any) is there in birth rates?

Notes: 

- By European standards Portugal is a poor country, and in 1980 it had the same GDP per capita as Mexico.
- It's well known that families are larger in rural areas (i.e. `region` is a confounder).
- You should proceed as if an expert in this area has told you that you do not need to consider zero-inflation.  Zero-inflated models do not fit well to this data, probably because birth rates are lower than Fiji, many zeros are expected, and the likelihood is flat.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(gridExtra)
library(grid)
library(knitr)
library(kableExtra)

# Summary statistics for children
children_summary <- portugal %>%
  summarise(
    Mean = round(mean(children, na.rm = TRUE), 2),
    Median = round(median(children, na.rm = TRUE), 2),
    SD = round(sd(children, na.rm = TRUE), 2),
    Min = round(min(children, na.rm = TRUE), 2),
    Max = round(max(children, na.rm = TRUE), 2)
  )

# Create a table with caption
table_with_caption <- arrangeGrob(
  textGrob("Statistical Summary of Children Showing \nMean, Median, Standard Deviation, \nMinimum and Maximum", 
           gp = gpar(fontsize = 10)),
  tableGrob(children_summary),
  heights = c(0.5, 3.0),  # Adjust these values to control spacing
  ncol = 1
)

# Histogram for children with smaller title text
children_hist <- ggplot(portugal, aes(x = children)) +
  geom_histogram(bins = 30, fill = "blue", alpha = 0.6, color = "black") +
  theme_minimal() +
  labs(title = "Histogram of Number of Children:\nRight-Skewed Distribution with\nMost Families Having 2 to 3 Children", 
       x = "Number of Children", 
       y = "Frequency") +
  theme(plot.title = element_text(size = 10))

# Arrange everything in one figure
grid.arrange(
  table_with_caption,
  children_hist,
  ncol = 2,
  widths = c(1.5, 1),  # Equal widths for both columns
  top = textGrob("Figure 1: Statistical Summary and Histogram of response variable 'Children'",
                 gp = gpar(fontsize = 12, fontface = "bold"))
)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

# Summary statistics for categorical variables (Age Married and Literacy)
ageMarried_summary <- portugal %>%
  count(ageMarried) %>%
  rename(Category = ageMarried, Count = n)

literacy_summary <- portugal %>%
  count(literacy) %>%
  rename(Category = literacy, Count = n)

# Add 'Variable' column and combine the tables
x_var_summary <- bind_rows(
  mutate(ageMarried_summary, Variable = "Age Married"),
  mutate(literacy_summary, Variable = "Literacy")
)

# Reorder the columns to have 'Variable' first
x_var_summary <- x_var_summary[, c("Variable", "Category", "Count")]

# Create a table for X variables summary
x_var_table <- kable(x_var_summary, format = "latex", booktabs = TRUE, 
                      caption = "Statistical Summary of X Variables (Counts)") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# Bar plot for Age Married
ageMarried_bar <- ggplot(portugal, aes(x = factor(ageMarried))) +  # Make sure 'ageMarried' is treated as a factor
  geom_bar(fill = "green", alpha = 0.6, color = "black") +
  theme_minimal() +
  labs(title = "Age Married Distribution", x = "Age Married Category", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels to prevent overlap

literacy_bar <- ggplot(portugal, aes(x = literacy)) +
  geom_bar(fill = "orange", alpha = 0.6, color = "black") +
  theme_minimal() +
  labs(title = "Literacy Distribution", x = "Literacy", y = "Count")

# Arrange table & plots in one figure with adjusted widths
grid.arrange(tableGrob(x_var_summary), ageMarried_bar, literacy_bar, ncol = 3, 
             widths = c(2, 2,1.2),  # Adjust widths for all 3 columns
             top = textGrob("Figure 2: Statistical Summary and Histogram of independnet variables 'Age Married' and 'Literacy'. Out of 5148 samples, most samples married between 20 to 25, and there are 4567 samples who can read literature",
                            gp = gpar(fontsize = 10, fontface = "bold")))


```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Define groups
literate <- portugal$literacy == "yes"
illiterate <- portugal$literacy == "no"

# Create histogram for literate group
hist(portugal[literate, "children"], 
     breaks = 30, col = rgb(0, 0, 1, 0.5), 
     prob = TRUE, main = "Children vs. Literacy", 
     xlab = "children")

# Add histogram for illiterate group
hist(portugal[illiterate, "children"], 
     breaks = 30, col = rgb(1, 0, 0, 0.5), 
     prob = TRUE, add = TRUE)
     
# Add legend
legend("topright", legend = c("Literate", "Illiterate"), 
       fill = c(rgb(0, 0, 1, 0.5), rgb(1, 0, 0, 0.5)))

```
```{r, echo=FALSE, warning=FALSE, message=FALSE}
portugal$logYearsMarried = log(pmax(1, portugal$monthsSinceM)/12)
portugal$ageMarried = relevel(portugal$ageMarried, "25to30")
portugalFit = glm(children ~ offset(logYearsMarried) + literacy +
ageMarried, data = portugal, family = poisson)
knitr::kable(summary(portugalFit)$coef, digits = 3)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
summary(portugalFit)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library('glmmTMB')
portugalNB = glmmTMB(
children ~
offset(logYearsMarried) +
literacy + ageMarried, data = portugal, family=nbinom2)

knitr::kable(
  rbind(
    confint(portugalNB)[1:7, c(3, 1, 2)],
    sd = round(1 / sqrt(confint(portugalNB, parm = "sigma"))[3], digits = 3)
  )
)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
exp(confint(portugalNB, 1))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
1/sqrt(confint(portugalNB, parm = "sigma"))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
portugalNBCI = as.data.frame(exp(confint(portugalNB)[-1,]))
portugalNBCI$level = gsub(paste(names(portugalNB$xlevels), collapse='|'),
"", rownames(portugalNBCI))
portugalNBCI$variable=unlist(strsplit(rownames(portugalNBCI),portugalNBCI$level))
portugalNBCI$x = 1:nrow(portugalNBCI)
portugalNBCI$cex = sqrt(1/apply(log(portugalNBCI[,1:2]),1,diff))
forXaxis = tapply(portugalNBCI$x, portugalNBCI$variable, mean)
portugalNBCI[1:3,]
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Extract the fixed effects from the model
coef_values <- fixef(portugalNB)$cond

# Apply exp() to the coefficients (excluding the intercept)
exp_coef_values <- exp(coef_values[-1])

# Now you can use 'exp_coef_values' for plotting
matplot(portugalNBCI[, 1:2], type = 'n',
        xaxt = 'n', bty = 'n', log = 'y', ylab = 'RR')
segments(portugalNBCI$x, portugalNBCI[, 1], portugalNBCI$x, portugalNBCI[, 2])
points(portugalNBCI$x, exp_coef_values, pch = 15,
       cex = portugalNBCI$cex, col = '#00000030')
mtext(portugalNBCI$level, 1, at = portugalNBCI$x,
      las = 3, line = -1)
mtext(names(forXaxis), 1, at = forXaxis, line = -2)
abline(h = 1, lty = 3)

```
```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(MASS)
portugalNB2 <- glm.nb(children ~
offset(logYearsMarried) +
literacy + ageMarried, data = portugal)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
1/sqrt(portugalNB2$theta)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
sigma_est <- sigma(portugalNB)  # Extracts dispersion parameter
theta_glmmTMB <- 1 / sigma_est^2  # Convert to theta
theta_glmmTMB

```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
m <- aggregate(portugal$children, by=list(portugal$literacy, portugal$ageMarried), mean)

v <- aggregate(portugal$children, by=list(portugal$literacy, portugal$ageMarried), var)

tab<-cbind(m, v[,3])

knitr::kable(tab, digits=2,
col.names=c("literacy",
"agemarried", "Mean", "Variance"))

```

